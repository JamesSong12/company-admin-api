---
alwaysApply: false
description: "test 코드 작성시에만 적용되는 규칙"
globs: src/test/java/**/*Test.java
---

# 테스트 코드 작성 규칙

## 1. 테스트 유형

### Controller Test (@WebMvcTest 권장)
```java
@WebMvcTest
@ContextConfiguration(classes = SampleController.class)
@AutoConfigureMockMvc(addFilters = false)
class SampleControllerTest extends BaseMvcRestDocsTest {
    
    @MockBean
    private SampleService sampleService;
}
```

### 특징
- **@WebMvcTest**: Controller 레이어만 테스트 (빠른 실행)
- **@ContextConfiguration**: 특정 Controller만 로드
- **@AutoConfigureMockMvc(addFilters = false)**: Security 필터 비활성화
- **BaseMvcRestDocsTest 상속**: 공통 헬퍼 메서드 및 RestDocs 설정

## 2. 기본 구조

### Given-When-Then 패턴 필수
```java
@Test
void getSample() throws Exception {
    // given (준비)
    String sampleId = "SPL001";
    SampleResponseDto responseDto = SampleResponseDto.builder()
        .sampleId(sampleId)
        .sampleName("테스트 샘플")
        .build();
    
    when(sampleService.getSample(sampleId)).thenReturn(responseDto);
    
    // when (실행)
    ResultActions resultActions = getJsonWithAuth(
        "/samples/{sampleId}", 
        sampleId
    );
    
    // then (검증)
    resultActions.andExpect(status().isOk())
        .andDo(doc(
            "sample/get-sample",
            pathParameters(
                parameterWithName("sampleId").description("샘플 ID")
            ),
            successResponseFieldsWithData(
                fieldWithPath("sampleId").description("샘플 ID"),
                fieldWithPath("sampleName").description("샘플 이름")
            )
        ));
}
```

## 3. 테스트 케이스별 패턴

### 단건 조회 (GET)
```java
@Test
void getSample() throws Exception {
    // given
    String sampleId = "SPL001";
    when(sampleService.getSample(sampleId)).thenReturn(responseDto);
    
    // when
    ResultActions resultActions = getJsonWithAuth("/samples/{sampleId}", sampleId);
    
    // then
    resultActions.andExpect(status().isOk())
        .andDo(doc(
            "sample/get-sample",
            pathParameters(
                parameterWithName("sampleId").description("샘플 ID")
            ),
            successResponseFieldsWithData(
                fieldWithPath("sampleId").description("샘플 ID"),
                fieldWithPath("sampleName").description("샘플 이름")
            )
        ));
}
```

### 목록 조회 - 페이징 (GET)
```java
@Test
void getSamples() throws Exception {
    // given
    Pageable pageable = PageRequest.of(0, 10);
    Page<SampleResponseDto> responsePage = new PageImpl<>(
        List.of(responseDto1, responseDto2), 
        pageable, 
        2
    );
    
    when(sampleService.getSamples(any(SampleSearchRequestDto.class), any(Pageable.class)))
        .thenReturn(responsePage);
    
    // when
    ResultActions resultActions = performGetWithAuth("/samples")
        .param("keyword", "검색어")
        .param("page", "0")
        .param("size", "10");
    
    // then
    resultActions.andExpect(status().isOk())
        .andDo(doc(
            "sample/get-samples",
            queryParameters(
                parameterWithName("keyword").description("검색 키워드").optional(),
                parameterWithName("page").description("페이지 번호"),
                parameterWithName("size").description("페이지 크기")
            ),
            paginationResponseFields(
                fieldWithPath("sampleId").description("샘플 ID"),
                fieldWithPath("sampleName").description("샘플 이름")
            )
        ));
}
```

### 생성 (POST)
```java
@Test
void createSample() throws Exception {
    // given
    SampleCreateRequestDto requestDto = new SampleCreateRequestDto(
        "새 샘플", 
        "설명"
    );
    SampleResponseDto responseDto = SampleResponseDto.builder()
        .sampleId("SPL001")
        .sampleName("새 샘플")
        .build();
    
    when(sampleService.createSample(any(SampleCreateRequestDto.class)))
        .thenReturn(responseDto);
    
    // when
    ResultActions resultActions = postJsonWithAuth("/samples", requestDto);
    
    // then
    resultActions.andExpect(status().isCreated())
        .andDo(doc(
            "sample/create-sample",
            requestFields(
                fieldWithPath("sampleName").description("샘플 이름"),
                fieldWithPath("description").description("설명")
            ),
            successResponseFieldsWithData(
                fieldWithPath("sampleId").description("생성된 샘플 ID"),
                fieldWithPath("sampleName").description("샘플 이름")
            )
        ));
}
```

### 수정 (PUT)
```java
@Test
void updateSample() throws Exception {
    // given
    String sampleId = "SPL001";
    SampleUpdateRequestDto requestDto = new SampleUpdateRequestDto(
        "수정된 샘플", 
        "수정된 설명"
    );
    
    when(sampleService.updateSample(eq(sampleId), any(SampleUpdateRequestDto.class)))
        .thenReturn(responseDto);
    
    // when
    ResultActions resultActions = putJsonWithAuth(
        "/samples/{sampleId}", 
        requestDto, 
        sampleId
    );
    
    // then
    resultActions.andExpect(status().isOk())
        .andDo(doc(
            "sample/update-sample",
            pathParameters(
                parameterWithName("sampleId").description("샘플 ID")
            ),
            requestFields(
                fieldWithPath("sampleName").description("샘플 이름"),
                fieldWithPath("description").description("설명")
            ),
            successResponseFieldsWithData(
                fieldWithPath("sampleId").description("샘플 ID"),
                fieldWithPath("sampleName").description("샘플 이름")
            )
        ));
}
```

### 부분 수정 (PATCH)
```java
@Test
void updateSampleVisibility() throws Exception {
    // given
    String sampleId = "SPL001";
    SampleVisibilityRequestDto requestDto = new SampleVisibilityRequestDto(
        StatusCode.INACTIVE
    );
    
    when(sampleService.updateVisibility(eq(sampleId), any()))
        .thenReturn(responseDto);
    
    // when
    ResultActions resultActions = patchJsonWithAuth(
        "/samples/{sampleId}/visibility", 
        requestDto, 
        sampleId
    );
    
    // then
    resultActions.andExpect(status().isOk())
        .andDo(doc(
            "sample/update-visibility",
            pathParameters(
                parameterWithName("sampleId").description("샘플 ID")
            ),
            requestFields(
                fieldWithPath("statusCode").description("상태 코드")
            ),
            successResponseFieldsWithData(
                fieldWithPath("sampleId").description("샘플 ID"),
                fieldWithPath("statusCode").description("변경된 상태 코드")
            )
        ));
}
```

### 삭제 (DELETE)
```java
@Test
void deleteSample() throws Exception {
    // given
    String sampleId = "SPL001";
    doNothing().when(sampleService).deleteSample(sampleId);
    
    // when
    ResultActions resultActions = deleteWithAuth("/samples/{sampleId}", sampleId);
    
    // then
    resultActions.andExpect(status().isNoContent())
        .andDo(doc(
            "sample/delete-sample",
            pathParameters(
                parameterWithName("sampleId").description("샘플 ID")
            )
        ));
}
```

### 다건 삭제 (DELETE with Query Parameters)
```java
@Test
void deleteSamples() throws Exception {
    // given
    String queryString = "?sampleIds=SPL001&sampleIds=SPL002&sampleIds=SPL003";
    doNothing().when(sampleService).deleteSamples(any(List.class));
    
    // when
    ResultActions resultActions = deleteReq("/samples" + queryString);
    
    // then
    resultActions.andExpect(status().isNoContent())
        .andDo(doc(
            "sample/delete-samples",
            queryParameters(
                parameterWithName("sampleIds").description("삭제할 샘플 ID 배열")
            )
        ));
}
```

## 4. Mockito 사용

### Service Mocking
```java
@MockBean
private SampleService sampleService;

// 특정 파라미터로 호출 시
when(sampleService.getSample("SPL001")).thenReturn(responseDto);

// any() 사용
when(sampleService.getSample(any(String.class))).thenReturn(responseDto);

// eq()와 any() 조합
when(sampleService.updateSample(eq("SPL001"), any(SampleUpdateRequestDto.class)))
    .thenReturn(responseDto);

// void 메서드 (삭제 등)
doNothing().when(sampleService).deleteSample(any(String.class));
```

## 5. BaseMvcRestDocsTest 헬퍼 메서드

### 인증 헤더 포함 요청 (권장)
```java
// GET
getJsonWithAuth("/samples/{id}", sampleId)

// POST
postJsonWithAuth("/samples", requestDto)

// PUT
putJsonWithAuth("/samples/{id}", requestDto, sampleId)

// PATCH
patchJsonWithAuth("/samples/{id}/visibility", requestDto, sampleId)

// DELETE
deleteWithAuth("/samples/{id}", sampleId)

// GET with params (빌더 패턴)
performGetWithAuth("/samples")
    .param("page", "0")
    .param("size", "10")
    .param("keyword", "검색어")
```

### 인증 헤더 미포함 요청
```java
// GET
getJson("/samples/{id}", sampleId)

// POST
postJson("/samples", requestDto)

// PUT
putJson("/samples/{id}", requestDto, sampleId)

// PATCH
patchJson("/samples/{id}/visibility", requestDto, sampleId)

// DELETE
deleteReq("/samples/{id}", sampleId)
```

## 6. RestDocs 문서화

### doc() 헬퍼 사용
```java
.andDo(doc(
    "document-identifier",  // 문서 ID (케밥-케이스)
    pathParameters(...),    // Path 파라미터
    queryParameters(...),   // Query 파라미터
    requestFields(...),     // Request Body 필드
    successResponseFieldsWithData(...)  // Response 필드
))
```

### 문서 ID 네이밍
```
{도메인}/{동작}

예시:
- sample/get-sample
- sample/get-samples
- sample/create-sample
- sample/update-sample
- sample/delete-sample
```

### Path Parameters
```java
pathParameters(
    parameterWithName("sampleId").description("샘플 ID"),
    parameterWithName("workspaceId").description("워크스페이스 ID")
)
```

### Query Parameters
```java
queryParameters(
    parameterWithName("page").description("페이지 번호"),
    parameterWithName("size").description("페이지 크기"),
    parameterWithName("keyword").description("검색 키워드").optional(),
    parameterWithName("direction").description("정렬 방향 (ASC|DESC)").optional()
)
```

### Request Fields
```java
requestFields(
    fieldWithPath("sampleName").description("샘플 이름"),
    fieldWithPath("description").description("설명"),
    fieldWithPath("statusCode").description("상태 코드").optional()
)
```

### Response Fields

#### 단건 응답
```java
successResponseFieldsWithData(
    fieldWithPath("sampleId").type(JsonFieldType.STRING).description("샘플 ID"),
    fieldWithPath("sampleName").type(JsonFieldType.STRING).description("샘플 이름"),
    fieldWithPath("statusCode").type(JsonFieldType.STRING).description("상태 코드"),
    fieldWithPath("createDatetime").type(JsonFieldType.STRING).description("생성일시"),
    fieldWithPath("updateDatetime").type(JsonFieldType.STRING).description("수정일시")
)
```

#### 리스트 응답
```java
listResponseFieldsWithData(
    fieldWithPath("sampleId").type(JsonFieldType.STRING).description("샘플 ID"),
    fieldWithPath("sampleName").type(JsonFieldType.STRING).description("샘플 이름")
)
```

#### 페이징 응답
```java
paginationResponseFields(
    fieldWithPath("sampleId").type(JsonFieldType.STRING).description("샘플 ID"),
    fieldWithPath("sampleName").type(JsonFieldType.STRING).description("샘플 이름"),
    fieldWithPath("statusCode").type(JsonFieldType.STRING).description("상태 코드")
)
```

## 7. 테스트 데이터 생성

### 헬퍼 메서드 패턴
```java
private SampleResponseDto getSampleResponseDto() {
    return SampleResponseDto.builder()
        .sampleId("SPL001")
        .sampleName("테스트 샘플")
        .statusCode(StatusCode.ACTIVE)
        .createDatetime(LocalDateTime.now())
        .updateDatetime(LocalDateTime.now())
        .build();
}

private List<SampleResponseDto> getSampleList() {
    return List.of(
        getSampleResponseDto(),
        SampleResponseDto.builder()
            .sampleId("SPL002")
            .sampleName("테스트 샘플 2")
            .build()
    );
}
```

### 상수 사용
```java
class SampleControllerTest extends BaseMvcRestDocsTest {
    private static final String SAMPLE_ID = "SPL123456789012";
    private static final String BASE_URL = "/samples";
    
    @MockBean
    private SampleService sampleService;
}
```

## 8. 실제 예시

### 예시 1: 단건 조회
```java
@WebMvcTest
@ContextConfiguration(classes = SampleController.class)
@AutoConfigureMockMvc(addFilters = false)
class SampleControllerTest extends BaseMvcRestDocsTest {
    
    private static final String SAMPLE_ID = "SPL123456789012";
    
    @MockBean
    private SampleService sampleService;
    
    @Test
    void getSample() throws Exception {
        // given
        SampleResponseDto responseDto = SampleResponseDto.builder()
            .sampleId(SAMPLE_ID)
            .sampleName("테스트 샘플")
            .statusCode(StatusCode.ACTIVE)
            .createDatetime(LocalDateTime.now())
            .updateDatetime(LocalDateTime.now())
            .build();
        
        when(sampleService.getSample(eq(SAMPLE_ID))).thenReturn(responseDto);
        
        // when
        ResultActions resultActions = getJson("/samples/{sampleId}", SAMPLE_ID);
        
        // then
        resultActions.andExpect(status().isOk())
            .andDo(doc(
                "sample/get-sample",
                pathParameters(
                    parameterWithName("sampleId").description("샘플 ID")
                ),
                successResponseFieldsWithData(
                    fieldWithPath("sampleId").type(JsonFieldType.STRING).description("샘플 ID"),
                    fieldWithPath("sampleName").type(JsonFieldType.STRING).description("샘플 이름"),
                    fieldWithPath("statusCode").type(JsonFieldType.STRING).description("상태 코드"),
                    fieldWithPath("createDatetime").type(JsonFieldType.STRING).description("생성일시"),
                    fieldWithPath("updateDatetime").type(JsonFieldType.STRING).description("수정일시")
                )
            ));
    }
}
```

### 예시 2: 페이징 조회
```java
@Test
void getSamples() throws Exception {
    // given
    String queryString = "?keyword=검색어" +
        "&direction=ASC" +
        "&page=0" +
        "&size=10";
    
    Pageable pageable = PageRequest.of(0, 10);
    Page<SampleResponseDto> responsePage = new PageImpl<>(
        List.of(getSampleResponseDto(), getSampleResponseDto()), 
        pageable, 
        2
    );
    
    when(sampleService.getSamples(any(SampleSearchRequestDto.class), any(Pageable.class)))
        .thenReturn(responsePage);
    
    // when
    ResultActions resultActions = getJson("/samples" + queryString);
    
    // then
    resultActions.andExpect(status().isOk())
        .andDo(doc(
            "sample/get-samples",
            queryParameters(
                parameterWithName("keyword").description("검색 키워드").optional(),
                parameterWithName("direction").description("정렬 방향 (ASC|DESC)").optional(),
                parameterWithName("page").description("페이지 번호"),
                parameterWithName("size").description("페이지 크기")
            ),
            paginationResponseFields(
                fieldWithPath("sampleId").type(JsonFieldType.STRING).description("샘플 ID"),
                fieldWithPath("sampleName").type(JsonFieldType.STRING).description("샘플 이름"),
                fieldWithPath("statusCode").type(JsonFieldType.STRING).description("상태 코드")
            )
        ));
}
```

### 예시 3: 생성
```java
@Test
void createSample() throws Exception {
    // given
    SampleCreateRequestDto requestDto = new SampleCreateRequestDto(
        "새 샘플", 
        "새로운 샘플입니다."
    );
    
    when(sampleService.createSample(any(SampleCreateRequestDto.class)))
        .thenReturn(getSampleResponseDto());
    
    // when
    ResultActions resultActions = postJson("/samples", requestDto);
    
    // then
    resultActions.andExpect(status().isCreated())
        .andDo(doc(
            "sample/create-sample",
            requestFields(
                fieldWithPath("sampleName").description("샘플 이름"),
                fieldWithPath("description").description("설명")
            ),
            successResponseFieldsWithData(
                fieldWithPath("sampleId").type(JsonFieldType.STRING).description("생성된 샘플 ID"),
                fieldWithPath("sampleName").type(JsonFieldType.STRING).description("샘플 이름"),
                fieldWithPath("statusCode").type(JsonFieldType.STRING).description("상태 코드")
            )
        ));
}
```

### 예시 4: 수정
```java
@Test
void updateSample() throws Exception {
    // given
    SampleUpdateRequestDto requestDto = new SampleUpdateRequestDto(
        "수정된 샘플", 
        "수정된 설명"
    );
    
    when(sampleService.updateSample(any(String.class), any(SampleUpdateRequestDto.class)))
        .thenReturn(getSampleResponseDto());
    
    // when
    ResultActions resultActions = putJson("/samples/{sampleId}", requestDto, SAMPLE_ID);
    
    // then
    resultActions.andExpect(status().isOk())
        .andDo(doc(
            "sample/update-sample",
            pathParameters(
                parameterWithName("sampleId").description("샘플 ID")
            ),
            requestFields(
                fieldWithPath("sampleName").description("샘플 이름"),
                fieldWithPath("description").description("설명")
            ),
            successResponseFieldsWithData(
                fieldWithPath("sampleId").type(JsonFieldType.STRING).description("샘플 ID"),
                fieldWithPath("sampleName").type(JsonFieldType.STRING).description("샘플 이름")
            )
        ));
}
```

### 예시 5: 삭제
```java
@Test
void deleteSample() throws Exception {
    // given
    doNothing().when(sampleService).deleteSample(any(String.class));
    
    // when
    ResultActions resultActions = deleteReq("/samples/{sampleId}", SAMPLE_ID);
    
    // then
    resultActions.andExpect(status().isNoContent())
        .andDo(doc(
            "sample/delete-sample",
            pathParameters(
                parameterWithName("sampleId").description("샘플 ID")
            )
        ));
}
```

## 9. 주의사항

### @WebMvcTest 사용
```java
// ✅ 권장 (빠른 테스트)
@WebMvcTest
@ContextConfiguration(classes = SampleController.class)
class SampleControllerTest extends BaseMvcRestDocsTest {
    @MockBean
    private SampleService sampleService;
}

// ❌ @SpringBootTest는 필요한 경우에만
@SpringBootTest
class SampleIntegrationTest {
    // 전체 애플리케이션 컨텍스트 로드 (느림)
}
```

### Mockito ArgumentMatchers
```java
// ✅ any() 사용
when(sampleService.getSample(any(String.class))).thenReturn(responseDto);

// ✅ eq()와 any() 조합
when(sampleService.updateSample(eq("SPL001"), any(SampleUpdateRequestDto.class)))
    .thenReturn(responseDto);

// ❌ eq()와 실제 값 혼용 금지
when(sampleService.updateSample("SPL001", any()))  // 금지
```

### 인증 헤더
```java
// ✅ 인증이 필요한 API는 WithAuth 메서드 사용
getJsonWithAuth("/samples/{id}", sampleId)
postJsonWithAuth("/samples", requestDto)

// ✅ 헬스체크 등 인증 불필요한 경우
getJson("/health")
```

### 테스트 메서드 네이밍
```java
// ✅ 동사형 (한글 또는 영문)
@Test
void getSample() { }

@Test
void 샘플_조회_성공() { }

@Test
void createSample() { }

// ❌ 너무 긴 이름 지양
@Test
void 샘플을_아이디로_조회했을때_정상적으로_반환되는지_확인() { }
```

### RestDocs 필드 타입
```java
// JsonFieldType 명시 권장
fieldWithPath("sampleId").type(JsonFieldType.STRING).description("샘플 ID")
fieldWithPath("count").type(JsonFieldType.NUMBER).description("개수")
fieldWithPath("isActive").type(JsonFieldType.BOOLEAN).description("활성 여부")
fieldWithPath("data").type(JsonFieldType.OBJECT).description("데이터 객체")
fieldWithPath("items").type(JsonFieldType.ARRAY).description("아이템 배열")
```

### Page 객체 생성
```java
// ✅ PageImpl 사용
Pageable pageable = PageRequest.of(0, 10);
Page<SampleResponseDto> page = new PageImpl<>(
    dataList,    // 데이터
    pageable,    // Pageable
    totalCount   // 전체 개수
);

// 사용
when(sampleService.getSamples(any(), any(Pageable.class))).thenReturn(page);
```

### 날짜 처리
```java
// 한국 시간대 사용
LocalDateTime nowSeoul = LocalDateTime.now(ZoneId.of("Asia/Seoul"));

// DTO에 설정
SampleResponseDto.builder()
    .createDatetime(nowSeoul)
    .updateDatetime(nowSeoul)
    .build();
```